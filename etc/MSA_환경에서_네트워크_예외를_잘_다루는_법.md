# MSA 환경에서 네트워크 예외를 잘 다루는 방법
카카오페이 글 공부 기록 (https://tech.kakaopay.com/post/msa-transaction/)

### MSA와 글로벌 트랜잭션
MSA는 각 서비스마다 DB가 따로 있기 때문에 트랜잭션에 참여하는 서비스가 여럿이라 하더라도 각 DB에 걸쳐서 데이터 일관성을 보장할 수 있어야 한다.
DB에 걸친 트랜잭션을 글로벌 트랜잭션, 분산 트랜잭션이라고도 표현한다. 

### 네트워크 요청의 성공과 예외 처리 
네트워크 통신에서의 예외적인 상황
- 같은 요청이 짧은 시간에 두 번 이상 발생
- 네트워크 순서가 뒤집힘
- 각종 타임아웃
- 인프라 문제 등등

### 알 수 없는 에러 처리
- 타임 아웃 등...
결제 서버로 요청이 들어간건지... 요청은 갔으나 성공했는지.. 또는 실패했는지....
이런 것들은 후처리를 통해 트랜잭션 보정이 가능하다.
- 즉시 재요청 시도
- 일정 시간 뒤 재시도 
- 결제 취소 요청 (보상 트랜잭션 등)


### 무한 루프 에러 처리
하지만 후처리 또한 API를 요청하는 형태이므로 알 수 없는 예외 상황 발생 
-> 보상 트랜잭션의 보상 트랜잭션의 보상 트랜잭션....?!

그래서 후처리까지 실패하면 -> 알 수 없는 상태로 저장 후 사용자에게는 재시도 안내 응답.
고객에 의해 재시도 되면 해당 결제건이 알 수 없음으로 저장된 트랜잭션인지 확인하고 후처리 다시 진행!

### 멱등성 API
실패로 간주하기 어려운 예외 상황에서 주문 서버는 결제 서버를 향해 후처리 API 요청을 하게 된다.
주문 서버는 타임 아웃으로 인해 알 수 없는 에러로 간주하고 결제 요청을 다시 시도!
- 이미 성공한 결제 요청이 두 번 들어오면?
    - 실패로 응답
    - 성공으로 응답 

동일한 요청을 여러번 보내도 같은 응답을 줄 수 있으면 해당 API는 멱등성이 있다고 표현한다.
-> 동일한 요청이 무엇인가?

```json
{
  "user_id": 1,
  "amount": 1000,
  "tx_key": "unique key per transaction" 
}
```

